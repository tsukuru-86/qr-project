<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ドリンクスキャン</title>
  <!-- Bootstrap CSSの読み込み -->
  <link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
  />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    #map {
      height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1 class="mt-5">ドリンクをスキャンしました！</h1>
    <p id="stats">他のユーザー情報を取得中...</p>
    <div id="map"></div>
  </div>

  <!-- 必要なスクリプトの読み込み -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script
    src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
  ></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // URLパラメータからdrink_idを取得
    const urlParams = new URLSearchParams(window.location.search);
    const drinkId = urlParams.get('drink_id');

    // デバッグ用ログ
    console.log('drinkId:', drinkId);

    // ユーザーの位置情報を取得
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;

        // デバッグ用ログ
        console.log('Latitude:', latitude, 'Longitude:', longitude);

        // サーバーにデータを送信
        fetch('/api/scan', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            drinkId,
            location: {
              type: 'Point',
              coordinates: [longitude, latitude],
            },
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Data saved:', data);
            // 他のユーザー情報を取得して表示
            return fetch('/api/stats');
          })
          .then((response) => response.json())
          .then((data) => {
            const p = document.getElementById('stats');
            p.textContent = `本日、このドリンクを飲んだ人数: ${data.totalScansToday}人`;

            // 地図の表示
            const map = L.map('map').setView([latitude, longitude], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.marker([latitude, longitude]).addTo(map)
              .bindPopup('あなたの位置')
              .openPopup();

            // サーバーから他のユーザーの位置を取得
            fetch('/api/locations')
              .then((response) => response.json())
              .then((data) => {
                data.locations.forEach((loc) => {
                  L.marker([loc.coordinates[1], loc.coordinates[0]])
                    .addTo(map)
                    .bindPopup('他のユーザー');
                });
              })
              .catch((error) => {
                console.error('Error:', error);
              });
          })
          .catch((error) => {
            console.error('Error:', error);
          });
      },
      (error) => {
        console.error('位置情報の取得に失敗しました:', error);
      }
    );
  </script>
</body>
</html>
